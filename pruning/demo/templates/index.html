<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TinyML Demo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

</head>
<body>
    <div class="container my-5">
        <h1>Descript Audio Codec Pruning Demo</h1>
        <div class="my-4 d-flex">
            <button class="btn btn-primary mx-2" id="recordBtn">Record</button>
            <button class="btn btn-danger mx-2" id="stopBtn" disabled>Stop</button>
            <button class="btn btn-success mx-2" id="processBtn" disabled>Submit</button>
            <audio class="mx-2" id="player" controls></audio>
            <div id="spinner" class="spinner-border text-primary mt-3 d-none" role="status">
                <span class="visually-hidden">Processing...</span>
            </div>
        </div>
        <div id="results" class="mt-5"></div>
    </div>

    <script>
        let recorder, audioBlob;

        // start recording
        document.getElementById('recordBtn').addEventListener('click', async () => {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            recorder = new MediaRecorder(stream);

            const chunks = [];
            recorder.ondataavailable = event => chunks.push(event.data);

            recorder.onstop = () => {
                audioBlob = new Blob(chunks, { type: recorder.mimeType });
                const url = URL.createObjectURL(audioBlob);
                document.getElementById('player').src = url;
                document.getElementById('processBtn').disabled = false;
            };

            recorder.start();
            document.getElementById('stopBtn').disabled = false;
            document.getElementById('recordBtn').disabled = true;
        });

        // stop recording
        document.getElementById('stopBtn').addEventListener('click', () => {
            recorder.stop();
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('recordBtn').disabled = false;
        });

        // process audio
        document.getElementById('processBtn').addEventListener('click', () => {
            const formData = new FormData();
            formData.append('audio', audioBlob);

            document.getElementById('spinner').classList.remove('d-none');
            axios.post('/process', formData)
                .then(response => {
                    document.getElementById('spinner').classList.add('d-none');
                    const resultsDiv = document.getElementById('results');
                    resultsDiv.innerHTML = '';

                    response.data.results.forEach(result => {
                        const resultElement = `
                            <div class="card my-3">
                                <div class="card-body">
                                    <h5 class="card-title">${result.name}</h5>
                                    <p>Compression Time: ${result.time1}</p>
                                    <p>Decompression Time: ${result.time2}</p>
                                    <audio controls>
                                        <source src="${result.file}" type="audio/wav">
                                        Your browser does not support the audio element.
                                    </audio>
                                </div>
                            </div>
                        `;
                        resultsDiv.insertAdjacentHTML('beforeend', resultElement);
                    });
                });
        });
    </script>
</body>
</html>
